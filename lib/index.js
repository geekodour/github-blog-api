'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_isomorphicFetch=require('isomorphic-fetch'),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),_marked=require('marked'),_marked2=_interopRequireDefault(_marked),_slugify=require('slugify'),_slugify2=_interopRequireDefault(_slugify),_parseLinkHeader=require('parse-link-header'),_parseLinkHeader2=_interopRequireDefault(_parseLinkHeader);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var API_URL='https://api.github.com',Blog=function(){function a(b){if(_classCallCheck(this,a),!(b.username&&b.repo&&b.author))throw new TypeError('Provide a username and repository to create a blog');this.settings={username:b.username||'',repo:b.repo||'',author:b.author||'',posts:{per_page:10,last_reached:!1,next_page_url:''},comments:{per_page:10,cur_post:null,done_posts:[],next_page_url:''},repoUrl:API_URL+'/repos/'+b.username+'/'+b.repo,blogUrl:API_URL+'/repos/'+b.username+'/'+b.repo+'/issues'}}return _createClass(a,[{key:'setPost',value:function setPost(a){this.settings.posts=Object.assign(this.settings.posts,a)}},{key:'setComment',value:function setComment(a){this.settings.comments=Object.assign(this.settings.comments,a)}},{key:'fetchAllLabels',value:function fetchAllLabels(){return(0,_isomorphicFetch2.default)(this.settings.repoUrl+'/labels?per_page=90').then(function(a){return 200===a.status?a.json():Promise.reject(new Error('api responded unexpectedly'))}).then(function(a){return a.map(function(a){return{name:a.name,color:a.color,slug:(0,_slugify2.default)(a.name)}})}).catch(function(a){throw a&&(a=a.message),a})}},{key:'fetchBlogPosts',value:function fetchBlogPosts(){var a=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];if(this.settings.posts.last_reached)return Promise.resolve([]);var c=this.settings.posts.next_page_url||this.settings.blogUrl+'?per_page='+this.settings.posts.per_page+'&page=1&creator='+this.settings.author+'&labels='+b.join(',');return(0,_isomorphicFetch2.default)(c).then(function(b){if(200!==b.status)return Promise.reject(new Error('api responded unexpectedly'));if(b.headers.has('link')){var c=(0,_parseLinkHeader2.default)(b.headers.get('link'));Object.prototype.hasOwnProperty.call(c,'next')?a.settings.posts.next_page_url=c.next.url:(a.settings.posts.next_page_url='',a.settings.posts.last_reached=!0)}else a.settings.posts.next_page_url='',a.settings.posts.last_reached=!0;return b.json()}).then(function(a){return a.map(function(a){return{body:a.body,html:(0,_marked2.default)(a.body),id:a.number,title:a.title,slug:(0,_slugify2.default)(a.title),date:a.created_at,labels:a.labels.map(function(a){return{name:a.name,color:a.color,slug:(0,_slugify2.default)(a.name)}}),comments_no:a.comments}})}).catch(function(a){throw a&&(a=a.message),a})}},{key:'fetchBlogPost',value:function fetchBlogPost(a){return(0,_isomorphicFetch2.default)(this.settings.blogUrl+('/'+a)).then(function(a){return 200===a.status?a.json():Promise.reject(new Error('api responded unexpectedly'))}).then(function(a){return{title:a.title,slug:(0,_slugify2.default)(a.title),id:a.number,labels:a.labels.map(function(a){return{name:a.name,color:a.color,slug:(0,_slugify2.default)(a.name)}}),comments:a.comments,date:a.created_at,body:a.body,html:(0,_marked2.default)(a.body)}}).catch(function(a){throw a&&(a=a.message),a})}},{key:'fetchBlogPostComments',value:function fetchBlogPostComments(a){var b=this;if(-1!==this.settings.comments.done_posts.indexOf(a))return Promise.resolve([]);a!==this.settings.comments.cur_post&&(this.settings.comments.next_page_url=''),this.settings.comments.cur_post=a;var c=this.settings.comments.next_page_url||this.settings.blogUrl+'/'+a+'/comments?per_page='+this.settings.comments.per_page+'&page=1';return(0,_isomorphicFetch2.default)(c).then(function(c){if(200!==c.status)return Promise.reject(new Error('api responded unexpectedly'));if(c.headers.has('link')){var d=(0,_parseLinkHeader2.default)(c.headers.get('link'));Object.prototype.hasOwnProperty.call(d,'next')?b.settings.comments.next_page_url=d.next.url:(b.settings.comments.next_page_url='',b.settings.comments.done_posts=[].concat(_toConsumableArray(b.settings.comments.done_posts),[a]))}else b.settings.comments.next_page_url='',b.settings.comments.done_posts=[].concat(_toConsumableArray(b.settings.comments.done_posts),[a]);return c.json()}).then(function(a){return a.map(function(a){return{id:a.id,user:{username:a.user.login,avatar_url:a.user.avatar_url},body:a.body,created_at:a.created_at,html:(0,_marked2.default)(a.body)}})}).catch(function(a){throw a&&(a=a.message),a})}},{key:'createPost',value:function createPost(a,b){if(!(a&&b))throw new TypeError('Provide PostObject and AUTH_TOKEN to create posts');return(0,_isomorphicFetch2.default)(API_URL+'/repos/geekodour/gitpushblog/issues',{method:'post',headers:new Headers({'Content-Type':'application/json',Authorization:'Basic '+b}),body:JSON.stringify(a)}).then(function(a){return a.json()}).then(function(a){return a}).catch(function(a){throw a&&(a=a.message),a})}},{key:'createComment',value:function createComment(a,b,c){if(!(a&&b&&c))throw new TypeError('Provide commentObj, postId and AUTH_TOKEN to create comments');return(0,_isomorphicFetch2.default)(API_URL+'/repos/geekodour/gitpushblog/issues/'+b+'/comments',{method:'post',headers:new Headers({'Content-Type':'application/json',Authorization:'token '+c}),body:JSON.stringify(a)}).then(function(a){return a.json()}).then(function(a){return a}).catch(function(a){throw a&&(a=a.message),a})}}]),a}();module.exports=function(a){return new Blog(a)};